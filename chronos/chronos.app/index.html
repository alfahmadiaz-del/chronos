
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronos</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/pouchdb@7.3.0/dist/pouchdb.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pouchdb-find@7.3.0/dist/pouchdb.find.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        class LocalDatabase {
            constructor() {
                this.db = new PouchDB('chronos');
                this.db.createIndex({
                    index: {fields: ['synced']}
                });
            }

            async saveEntry(userId, entryData) {
                const entry = {
                    _id: `entry_${userId}_${Date.now()}`,
                    userId,
                    ...entryData,
                    synced: false,
                };
                return await this.db.put(entry);
            }

            async saveVow(userId, vowData) {
                const vow = {
                    _id: `vow_${userId}_${Date.now()}`,
                    userId,
                    ...vowData,
                    status: 'Active',
                    completion_percentage: 0,
                    synced: false,
                };
                return await this.db.put(vow);
            }

            async updateVow(vowId, updates) {
                const vow = await this.db.get(vowId);
                const updatedVow = { ...vow, ...updates, synced: false };
                return await this.db.put(updatedVow);
            }

            async getEntries(userId) {
                const result = await this.db.allDocs({
                    include_docs: true,
                    startkey: `entry_${userId}_`,
                    endkey: `entry_${userId}_ufff0`,
                });
                return result.rows.map(row => row.doc);
            }

            async getVows(userId) {
                const result = await this.db.allDocs({
                    include_docs: true,
                    startkey: `vow_${userId}_`,
                    endkey: `vow_${userId}_ufff0`,
                });
                return result.rows.map(row => row.doc);
            }

            async getPendingSyncItems() {
              const result = await this.db.find({
                selector: { synced: { $eq: false } }
              });
              return result.docs;
            }

            async markAsSynced(docId) {
                let doc = await this.db.get(docId);
                doc.synced = true;
                return await this.db.put(doc);
            }
        }

        class SyncEngine {
            constructor(onSyncStatusChange) {
                this.db = new LocalDatabase();
                this.isOnline = navigator.onLine;
                this.isSyncing = false;
                this.onSyncStatusChange = onSyncStatusChange;
                this.syncInterval = null;

                window.addEventListener('online', () => this.handleOnlineStatusChange(true));
                window.addEventListener('offline', () => this.handleOnlineStatusChange(false));

                this.start();
            }

            handleOnlineStatusChange(isOnline) {
                this.isOnline = isOnline;
                this.onSyncStatusChange({
                    isOnline: this.isOnline,
                    isSyncing: this.isSyncing
                });
                if (isOnline) {
                    this.syncData();
                }
            }

            start() {
                this.syncInterval = setInterval(() => {
                    if (this.isOnline) {
                        this.syncData();
                    }
                }, 30000);
            }

            stop() {
                clearInterval(this.syncInterval);
            }

            async syncData() {
                if (this.isSyncing || !this.isOnline) {
                    return;
                }

                this.isSyncing = true;
                this.onSyncStatusChange({
                    isOnline: this.isOnline,
                    isSyncing: this.isSyncing
                });

                try {
                    const pendingItems = await this.db.getPendingSyncItems();
                    if (pendingItems.length > 0) {
                        console.log('Pending sync items:', pendingItems);
                        await new Promise(resolve => setTimeout(resolve, 500));
                        for (const item of pendingItems) {
                            await this.db.markAsSynced(item._id);
                        }
                    }
                } catch (error) {
                    console.error('Sync failed:', error);
                } finally {
                    this.isSyncing = false;
                    this.onSyncStatusChange({
                        isOnline: this.isOnline,
                        isSyncing: this.isSyncing
                    });
                }
            }
        }

        function Card({ title, children, className }) {
            return (
                <div className={`bg-gray-800 p-4 rounded-lg shadow-md ${className}`}>
                    <h3 className="text-lg font-bold mb-2">{title}</h3>
                    {children}
                </div>
            );
        }

        function EntryForm({ db, userId, onEntrySaved }) {
            const [formState, setFormState] = React.useState({ mood: 'Good' });

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setFormState(prevState => ({ ...prevState, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                await db.saveEntry(userId, { ...formState, date: new Date().toISOString() });
                onEntrySaved();
                setFormState({ mood: 'Good' });
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label className="block mb-1">Mood</label>
                        <select name="mood" value={formState.mood} onChange={handleInputChange} className="w-full p-2 bg-gray-700 rounded">
                            <option>Excellent</option>
                            <option>Good</option>
                            <option>Fair</option>
                            <option>Poor</option>
                        </select>
                    </div>
                    <textarea name="progress" placeholder="Progress/Achievements" onChange={handleInputChange} className="w-full p-2 bg-gray-700 rounded" />
                    <textarea name="goals" placeholder="Goals/Next Steps" onChange={handleInputChange} className="w-full p-2 bg-gray-700 rounded" />
                    <textarea name="actions" placeholder="Specific Actions" onChange={handleInputChange} className="w-full p-2 bg-gray-700 rounded" />
                    <textarea name="tasks_for_tomorrow" placeholder="Tasks for Tomorrow" onChange={handleInputChange} className="w-full p-2 bg-gray-700 rounded" />
                    <textarea name="journey_entry" placeholder="Journey Reflection" onChange={handleInputChange} className="w-full p-2 bg-gray-700 rounded" />
                    <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        Record Chronicle
                    </button>
                </form>
            );
        }

        function FutureVowsModal({ db, userId, onVowSaved, closeModal }) {
             const [formState, setFormState] = React.useState({ vowType: 'Progress' });

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setFormState(prevState => ({ ...prevState, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                await db.saveVow(userId, formState);
                onVowSaved();
                closeModal();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                    <div className="bg-gray-800 p-6 rounded-lg w-full max-w-md">
                        <h2 className="text-xl font-bold mb-4">Forge New Vow</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input type="text" name="title" placeholder="Vow Title" onChange={handleInputChange} className="w-full p-2 bg-gray-700 rounded" />
                            <select name="vowType" value={formState.vowType} onChange={handleInputChange} className="w-full p-2 bg-gray-700 rounded">
                                <option>Progress</option>
                                <option>Plan</option>
                            </select>
                            <input type="date" name="targetDate" onChange={handleInputChange} className="w-full p-2 bg-gray-700 rounded" />
                            <textarea name="commitment" placeholder="Commitment or Time Estimate" onChange={handleInputChange} className="w-full p-2 bg-gray-700 rounded" />
                            <div className="flex justify-end space-x-2">
                                <button type="button" onClick={closeModal} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Cancel</button>
                                <button type="submit" className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Forge Vow</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function Vow({ vow, onUpdate }) {
            const [showUpdate, setShowUpdate] = React.useState(false);
            const [progress, setProgress] = React.useState(vow.completion_percentage);

            const handleUpdate = () => {
                onUpdate(vow._id, { completion_percentage: progress, status: progress == 100 ? 'Completed' : vow.status });
                setShowUpdate(false);
            };
            
            const handleStatusChange = (status) => {
                onUpdate(vow._id, { status });
            }

            return (
                 <div className="bg-gray-700 p-3 rounded">
                    <p className="font-bold">{vow.title}</p>
                    <p>{vow.commitment}</p>
                    <p className="text-sm text-gray-400">Target: {new Date(vow.targetDate).toLocaleDateString()}</p>
                    <div className="relative pt-1">
                        <div className="overflow-hidden h-2 mb-4 text-xs flex rounded bg-gray-600">
                            <div style={{ width: `${vow.completion_percentage}%` }} className="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-green-500"></div>
                        </div>
                    </div>
                    <div className="flex justify-between items-center text-sm">
                        <p>Status: {vow.status}</p>
                        <div>
                           {vow.status === 'Active' && <button onClick={() => setShowUpdate(!showUpdate)} className="text-blue-400 hover:text-blue-300">Update</button>}
                           {vow.status === 'Active' && <button onClick={() => handleStatusChange('Completed')} className="ml-2 text-green-400 hover:text-green-300">Complete</button>}
                           {vow.status === 'Active' && <button onClick={() => handleStatusChange('Abandoned')} className="ml-2 text-red-400 hover:text-red-300">Abandon</button>}
                        </div>
                    </div>
                    {showUpdate && (
                        <div className="mt-2">
                            <input type="range" min="0" max="100" value={progress} onChange={(e) => setProgress(e.target.value)} className="w-full" />
                            <button onClick={handleUpdate} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded mt-2">Save Progress</button>
                        </div>
                    )}
                </div>
            )
        }

        function Chronicle({ entry }) {
             return (
                <div className="bg-gray-700 p-3 rounded">
                    <p className="text-sm text-gray-400">{new Date(entry.date).toLocaleString()}</p>
                    <p><strong>Mood:</strong> {entry.mood}</p>
                    {entry.progress && <p><strong>Progress:</strong> {entry.progress}</p>}
                    {entry.goals && <p><strong>Goals:</strong> {entry.goals}</p>}
                    {entry.actions && <p><strong>Actions:</strong> {entry.actions}</p>}
                    {entry.tasks_for_tomorrow && <p><strong>Tasks for Tomorrow:</strong> {entry.tasks_for_tomorrow}</p>}
                    {entry.journey_entry && <p><strong>Journey:</strong> {entry.journey_entry}</p>}
                </div>
            );
        }


        function App() {
            const [entries, setEntries] = React.useState([]);
            const [vows, setVows] = React.useState([]);
            const [syncStatus, setSyncStatus] = React.useState({ isOnline: navigator.onLine, isSyncing: false });
            const [showVowModal, setShowVowModal] = React.useState(false);
            const db = new LocalDatabase();
            const syncEngine = new SyncEngine(setSyncStatus);

            const userId = 'user_123';

            const loadData = async () => {
                const [entries, vows] = await Promise.all([
                    db.getEntries(userId),
                    db.getVows(userId)
                ]);
                setEntries(entries.sort((a, b) => new Date(b.date) - new Date(a.date)));
                setVows(vows.sort((a, b) => new Date(b.targetDate) - new Date(a.targetDate)));
            };

            const handleVowUpdate = async (vowId, updates) => {
                await db.updateVow(vowId, updates);
                loadData();
            }

            React.useEffect(() => {
                loadData();
                const dataLoadInterval = setInterval(loadData, 5000);
                return () => clearInterval(dataLoadInterval);
            }, []);

            return (
                <div className="bg-gray-900 text-white min-h-screen p-4">
                    {showVowModal && 
                        <FutureVowsModal 
                            db={db} 
                            userId={userId} 
                            onVowSaved={loadData} 
                            closeModal={() => setShowVowModal(false)} 
                        />
                    }
                    <header className="flex justify-between items-center mb-4">
                        <h1 className="text-2xl font-bold">Chronos</h1>
                        <div>
                            <span className={`inline-block w-3 h-3 rounded-full ${syncStatus.isOnline ? 'bg-green-500' : 'bg-red-500'}`}></span>
                            <span className="ml-2">{syncStatus.isOnline ? 'Online' : 'Offline'}</span>
                            {syncStatus.isSyncing && <span className="ml-2">Syncing...</span>}
                        </div>
                    </header>
                    <main className="grid md:grid-cols-2 gap-8">
                        <div>
                            <Card title="New Chronicle">
                                <EntryForm db={db} userId={userId} onEntrySaved={loadData} />
                            </Card>
                            <button onClick={() => setShowVowModal(true)} className="mt-4 w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">
                                Forge New Vow
                            </button>
                        </div>
                        <div>
                            <Card title="Vows">
                                <div className="space-y-4">
                                    {vows.map(vow => <Vow key={vow._id} vow={vow} onUpdate={handleVowUpdate} />)}
                                </div>
                            </Card>
                            <Card title="Daily Chronicles" className="mt-4">
                                 <div className="space-y-4">
                                    {entries.map(entry => <Chronicle key={entry._id} entry={entry} />)}
                                </div>
                            </Card>
                        </div>
                    </main>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/chronos.app/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>
</body>
</html>
